<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<noscript>Your browser does not support JavaScript!</noscript>

<head>
    <title>mothership-chart</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="shortcut icon" href="./favicon.ico" />
    <script type="text/javascript" src="./src/js/DrawInfo.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript" src="./src/js/dragresize.js"></script>
    <link rel="stylesheet" type="text/css" href="./src/css/dragresize.css" />
</head>

<body>
    <span id='about'>
        🚧尚在施工中🚧
        这是一个使用妈船api获取数据来作图的工具，与妈船和白菜bot没有任何关系
    </span>
    <br>
    <br>
    <div id='settings'>
        <span>osu apiKey: </span><input id='osuapikey' type="password" />
        <input id='check api' type="button" />
        <br>
        <br>
        <table id='dataListTable' style="text-align: center;">
            <tr>
                <td> <span>选择</span> </td>
            </tr>
            <tr>
                <td> <span>昵称</span> </td>
            </tr>
            <tr>
                <td> <span>uid（留空则自动获取）</span> </td>
            </tr>
            <tr>
                <td> <span>模式</span> </td>
            </tr>
            <tr>
                <td> <span>起始日期</span> </td>
            </tr>
            <tr>
                <td> <span>截止日期</span> </td>
            </tr>
            <tr>
                <td> <span>数据</span> </td>
            </tr>
            <tr>
                <td> <span>操作</span> </td>
            </tr>
        </table>
        <br>
        <br>
        <button id='addDataLineBtn'>添加数据</button>
        <span>添加预置：</span><select id='savedPlayerSelect'></select>
        <button id='delDataLineBtn'>删除数据</button>
        <br>
        <br>
        <span>x轴: </span><select id='xcor'>
            <option value="dateString">日期</option>
            <option value="pp">pp</option>
            <option value="playcount">pc</option>
            <option value="tth">tth</option>
            <option value="rankedscore">ranked 总分</option>
            <option value="totalscore">total 总分</option>
            <option value="level">等级</option>
        </select>
        <span>y轴：</span><select id='ycor'>
            <option value="pp">pp</option>
            <option value="rankworld">rank</option>
            <option value="accuracy">acc</option>
            <option value="playcount">pc</option>
            <option value="tth">tth</option>
            <option value="rankedscore">ranked 总分</option>
            <option value="totalscore">total 总分</option>
            <option value="level">等级</option>
            <option value="SS">SS总数</option>
            <option value="S">S总数</option>
            <option value="A">A总数</option>
            <option value="count50">50总数</option>
            <option value="count100">100总数</option>
            <option value="count300">300总数</option>
            <option value="tth_pc">tth/pc</option>
            <option value="tth_pp">tth/pp</option>
            <option value="pc_pp">pc/pp</option>
        </select>
        <button id='drawBtn'>绘制折线图</button>
        <span>当前状态：</span><span id='getDataConsole'>请先添加至少一条数据</span>
    </div>
    <br>
    <br>
    <div id='graph' class="drsElement drsMoveHandle"
        style='width: 1000px; height: 600px; border: 1px solid; bottom: 0px; right: 0px;'></div>

    <script type="text/javascript">
        var mothershipData = [];
        var dataIndex = -1;

        function getDateString(date, isApi = false) {
            const year = date.getFullYear().toString();
            let month = (date.getMonth() + 1).toString();
            if (month.length === 1) month = "0" + month;
            let day = date.getDate().toString();
            if (day.length === 1) day = "0" + day;
            return (isApi) ? year + month + day : year + "-" + month + "-" + day;
        }



        function updateTable() {
            const table = $("#playerlist");
            table.empty();
            const ttr = $("<tr>", { style: "background-color:#9898f3; line-height:30px;" });
            $("<td>", { text: "选择" }).appendTo(ttr);
            $("<td>", { text: "uid" }).appendTo(ttr);
            $("<td>", { text: "数据" }).appendTo(ttr);
            $("<td>", { text: "昵称" }).appendTo(ttr);
            ttr.appendTo(table);
            mothershipData.map((data, index) => {
                const ltr = $("<tr>", { style: "line-height:30px;" });
                let td = $("<td>").appendTo(ltr);
                $("<input>", { id: "dataCheck-" + index, type: "checkbox", style: "width: 20px; height:20px", text: " ", checked: true }).appendTo(td);
                td = $("<td>", { text: data.uid }).appendTo(ltr);
                td = $("<td>", { text: data.dataType }).appendTo(ltr);
                td = $("<td>").appendTo(ltr);
                let uname = $("<input>", { id: "dataName-" + index, type: "text", defaultText: data.uid });
                uname.val(data.name);
                uname.blur(function () {
                    if (uname.val() === "") uname.val(uname.attr("defaultText"));
                    let index = parseInt(uname.attr("id").split("-")[1]);
                    mothershipData[index].setName(uname.val());
                });
                uname.appendTo(td);
                ltr.appendTo(table);
            });
        }

        function getMothershipData($dataStat, userId, startDate, endDate, mode) {
            const data = {};
            data.start = getDateString(startDate, true);
            data.limit = Math.ceil((endDate - startDate) / (1000 * 3600 * 24));
            data.mode = mode;
            const url = `https://www.mothership.top/api/v1/userinfo/${userId}`;
            $.ajax({
                url: url,
                data: data,
                dataType: "json",
                success: function (resp) {
                    if (resp.code === 3) {
                        // 起始时间过早
                        const newStartDate = new Date(resp.data.year + "-" + resp.data.month + "-" + resp.data.day);
                        $('#startDate').val(getDateString(newStartDate));
                        $dataStat.text("起始日期太早，已自动修正，请重新获取数据");
                        $('#getDataBtn').removeAttr('disabled');
                        $('#saved-name').val($('#name').val());
                        $('#saved-uid').val($('#uid').val());
                        $('#saved-start').val($('#startDate').val());
                    }
                    else if (resp.code !== 0) $dataStat.text(resp.status);
                    else {
                        const user = new UserFull(resp.data, startDate, endDate);
                        const username = getPlaterName(userId);
                        const drawInfo = new DrawInfo(userId, user, $("#mode option[value=" + mode + "]").text() + ": " + getDateString(startDate) + "~" + getDateString(endDate), username);
                        mothershipData.push(drawInfo);
                        updateTable();
                        $('#getDataConsole').text("获取数据成功，您也可以继续添加");
                    }
                },
                error: function (xhr) {
                    $('#getDataConsole').text("从妈船获取数据失败（妈船api经常爆炸，过段时间再试试吧） " + xhr.status + " " + xhr.statusText);
                }
            });
        }

        function addDataLine(nick = "", uid = "", mode = 0, startDate = "") {
            const table = $("#dataListTable");
            dataIndex += 1;
            const ltr = $("<tr>", { style: "line-height:30px;" });
            // 选择
            let td = $("<td>").appendTo(ltr);
            let $choose = $("<input>", { id: "choose-" + dataIndex, type: "checkbox", style: "width: 20px; height:20px" }).appendTo(td);
            $choose.hide();
            // 昵称
            td = $("<td>").appendTo(ltr);
            $("<input>", { id: "nick-" + dataIndex, type: "text", val: nick }).appendTo(td);
            // uid
            td = $("<td>").appendTo(ltr);
            $("<input>", { id: "uid-" + dataIndex, type: "text", val: uid }).appendTo(td);
            // 模式
            td = $("<td>").appendTo(ltr);
            $("<select id='mode-" + dataIndex + "'><option value='0'>Standard</option><option value='1'>Taiko</option><option value='2'>Catch The Beat</option><option value='3'>Mania</option></select>").appendTo(td);
            // 起始日期
            td = $("<td>").appendTo(ltr);
            $("<input>", { id: "startDate-" + dataIndex, type: "text", val: startDate }).appendTo(td);
            // 截止日期
            td = $("<td>").appendTo(ltr);
            $("<input>", { id: "endDate-" + dataIndex, type: "text", val: getDateString(new Date()) }).appendTo(td);
            // 数据提示
            td = $("<td>").appendTo(ltr);
            $("<span>", { id: "dataStat-" + dataIndex, val: "请点击“获取数据”按钮" }).appendTo(td);
            // 操作
            td = $("<td>").appendTo(ltr);
            let $getDataBtn = $("<input>", { id: "getDataBtn-" + dataIndex, type: "button", val: "获取数据" }).appendTo(td);
            $getDataBtn.click(() => {
                const $this = $(this);
                $this.attr("disabled", true);
                const index = $this.attr("id").split("-")[1];
                const $dataStat = $("dataStat-" + index);
                $dataStat.text("正在获取数据，请稍等...");
                const userId = $("uid-" + index).val();
                const mode = parseInt($("mode-" + index).val());
                const startDate = new Date($("startDate-" + index).val());
                const endDate = new Date($("endDate-" + index).val());
                getMothershipData($dataStat, userId, startDate, endDate, mode);
                setTimeout(() => {
                    $(this).removeAttr('disabled');
                }, 5000);
            });

            let $saveSettingBtn = $("<input>", { id: "saveSetting-" + dataIndex, type: "button", val: "加入预置" }).appendTo(td);


            ltr.appendTo(table);
        }

    </script>

    <script type="text/javascript">
        let dragresize = new DragResize('dragresize',
            { minWidth: 50, minHeight: 50, minLeft: 20, minTop: 20, maxLeft: 10000, maxTop: 10000 });
        dragresize.isElement = function (elm) {
            if (elm.className && elm.className.indexOf('drsElement') > -1) return true;
        };
        dragresize.isHandle = function (elm) {
            if (elm.className && elm.className.indexOf('drsMoveHandle') > -1) return true;
        };
        dragresize.apply(document);
    </script>

    <script type="text/javascript">
        function downloadJSAtOnload() {
            $("#drawBtn").text("加载中，请稍等...");
            let element = document.createElement("script");
            element.src = "https://cdn.plot.ly/plotly-latest.min.js";
            element.onload = function () {
                $('#drawBtn').attr("disabled", false);
                $("#drawBtn").text("绘制折线图");
                $("#drawBtn").click(function () {
                    if (mothershipData.length <= 0) $("#graph").append($('<div class="draw-warning"><span>请先获取数据</span></div>'));
                    else {
                        $(".draw-warning").remove();
                        const xName = $("#xcor").val();
                        const xTitle = $("#xcor option[value=" + xName + "]").text()
                        const yName = $("#ycor").val();
                        const yTitle = $("#ycor option[value=" + yName + "]").text()
                        let datas = [];
                        $("#playerlist tr:gt(0)").each(function (index, tr) {
                            let checkbox = $("input:checkbox", tr);
                            if (checkbox.is(':checked')) {
                                let index = parseInt(checkbox.attr("id").split("-")[1]);
                                datas.push(mothershipData[index].getTrace(xName, yName));
                            }
                        });
                        const layout = {
                            title: {
                                text: xTitle + "-" + yTitle
                            },
                            xaxis: {
                                title: {
                                    text: xTitle
                                }
                            },
                            yaxis: {
                                title: {
                                    text: yTitle
                                }
                            }
                        };
                        Plotly.newPlot('graph', datas, layout, { scrollZoom: true });
                    }
                });
            }

            document.body.appendChild(element);
        }
        if (window.addEventListener)
            window.addEventListener("load", downloadJSAtOnload, false);
        else if (window.attachEvent)
            window.attachEvent("onload", downloadJSAtOnload);
        else window.onload = downloadJSAtOnload;

    </script>



</body>

</html>