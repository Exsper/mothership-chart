<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<noscript>Your browser does not support JavaScript!</noscript>

<head>
    <title>mothership-chart</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="shortcut icon" href="./favicon.ico" />
    <script type="text/javascript" src="./src/js/DrawInfo.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript" src="./src/js/dragresize.js"></script>
    <link rel="stylesheet" type="text/css" href="./src/css/dragresize.css" />
</head>

<body>
    <span id='about'>
        ğŸš§å°šåœ¨æ–½å·¥ä¸­ğŸš§
        è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨å¦ˆèˆ¹apiè·å–æ•°æ®æ¥ä½œå›¾çš„å·¥å…·ï¼Œä¸å¦ˆèˆ¹å’Œç™½èœbotæ²¡æœ‰ä»»ä½•å…³ç³»
    </span>
    <br>
    <br>
    <div id='settings'>
        <span>osu apiKey: </span><input id='osuapikey' type="password" />
        <input id='check api' type="button" />
        <br>
        <br>
        <table id='dataListTable' style="text-align: center;">
            <tr>
                <td> <span>é€‰æ‹©</span> </td>
            </tr>
            <tr>
                <td> <span>æ˜µç§°</span> </td>
            </tr>
            <tr>
                <td> <span>uidï¼ˆç•™ç©ºåˆ™è‡ªåŠ¨è·å–ï¼‰</span> </td>
            </tr>
            <tr>
                <td> <span>æ¨¡å¼</span> </td>
            </tr>
            <tr>
                <td> <span>èµ·å§‹æ—¥æœŸ</span> </td>
            </tr>
            <tr>
                <td> <span>æˆªæ­¢æ—¥æœŸ</span> </td>
            </tr>
            <tr>
                <td> <span>æ•°æ®</span> </td>
            </tr>
            <tr>
                <td> <span>æ“ä½œ</span> </td>
            </tr>
        </table>
        <br>
        <br>
        <button id='addDataLineBtn'>æ·»åŠ æ•°æ®</button>
        <span>æ·»åŠ é¢„ç½®ï¼š</span><select id='savedPlayerSelect'></select>
        <button id='delDataLineBtn'>åˆ é™¤æ•°æ®</button>
        <br>
        <br>
        <span>xè½´: </span><select id='xcor'>
            <option value="dateString">æ—¥æœŸ</option>
            <option value="pp">pp</option>
            <option value="playcount">pc</option>
            <option value="tth">tth</option>
            <option value="rankedscore">ranked æ€»åˆ†</option>
            <option value="totalscore">total æ€»åˆ†</option>
            <option value="level">ç­‰çº§</option>
        </select>
        <span>yè½´ï¼š</span><select id='ycor'>
            <option value="pp">pp</option>
            <option value="rankworld">rank</option>
            <option value="accuracy">acc</option>
            <option value="playcount">pc</option>
            <option value="tth">tth</option>
            <option value="rankedscore">ranked æ€»åˆ†</option>
            <option value="totalscore">total æ€»åˆ†</option>
            <option value="level">ç­‰çº§</option>
            <option value="SS">SSæ€»æ•°</option>
            <option value="S">Sæ€»æ•°</option>
            <option value="A">Aæ€»æ•°</option>
            <option value="count50">50æ€»æ•°</option>
            <option value="count100">100æ€»æ•°</option>
            <option value="count300">300æ€»æ•°</option>
            <option value="tth_pc">tth/pc</option>
            <option value="tth_pp">tth/pp</option>
            <option value="pc_pp">pc/pp</option>
        </select>
        <button id='drawBtn'>ç»˜åˆ¶æŠ˜çº¿å›¾</button>
        <span>å½“å‰çŠ¶æ€ï¼š</span><span id='getDataConsole'>è¯·å…ˆæ·»åŠ è‡³å°‘ä¸€æ¡æ•°æ®</span>
    </div>
    <br>
    <br>
    <div id='graph' class="drsElement drsMoveHandle"
        style='width: 1000px; height: 600px; border: 1px solid; bottom: 0px; right: 0px;'></div>

    <script type="text/javascript">
        var mothershipData = [];
        var dataIndex = -1;

        function getDateString(date, isApi = false) {
            const year = date.getFullYear().toString();
            let month = (date.getMonth() + 1).toString();
            if (month.length === 1) month = "0" + month;
            let day = date.getDate().toString();
            if (day.length === 1) day = "0" + day;
            return (isApi) ? year + month + day : year + "-" + month + "-" + day;
        }



        function updateTable() {
            const table = $("#playerlist");
            table.empty();
            const ttr = $("<tr>", { style: "background-color:#9898f3; line-height:30px;" });
            $("<td>", { text: "é€‰æ‹©" }).appendTo(ttr);
            $("<td>", { text: "uid" }).appendTo(ttr);
            $("<td>", { text: "æ•°æ®" }).appendTo(ttr);
            $("<td>", { text: "æ˜µç§°" }).appendTo(ttr);
            ttr.appendTo(table);
            mothershipData.map((data, index) => {
                const ltr = $("<tr>", { style: "line-height:30px;" });
                let td = $("<td>").appendTo(ltr);
                $("<input>", { id: "dataCheck-" + index, type: "checkbox", style: "width: 20px; height:20px", text: " ", checked: true }).appendTo(td);
                td = $("<td>", { text: data.uid }).appendTo(ltr);
                td = $("<td>", { text: data.dataType }).appendTo(ltr);
                td = $("<td>").appendTo(ltr);
                let uname = $("<input>", { id: "dataName-" + index, type: "text", defaultText: data.uid });
                uname.val(data.name);
                uname.blur(function () {
                    if (uname.val() === "") uname.val(uname.attr("defaultText"));
                    let index = parseInt(uname.attr("id").split("-")[1]);
                    mothershipData[index].setName(uname.val());
                });
                uname.appendTo(td);
                ltr.appendTo(table);
            });
        }

        function getMothershipData($dataStat, userId, startDate, endDate, mode) {
            const data = {};
            data.start = getDateString(startDate, true);
            data.limit = Math.ceil((endDate - startDate) / (1000 * 3600 * 24));
            data.mode = mode;
            const url = `https://www.mothership.top/api/v1/userinfo/${userId}`;
            $.ajax({
                url: url,
                data: data,
                dataType: "json",
                success: function (resp) {
                    if (resp.code === 3) {
                        // èµ·å§‹æ—¶é—´è¿‡æ—©
                        const newStartDate = new Date(resp.data.year + "-" + resp.data.month + "-" + resp.data.day);
                        $('#startDate').val(getDateString(newStartDate));
                        $dataStat.text("èµ·å§‹æ—¥æœŸå¤ªæ—©ï¼Œå·²è‡ªåŠ¨ä¿®æ­£ï¼Œè¯·é‡æ–°è·å–æ•°æ®");
                        $('#getDataBtn').removeAttr('disabled');
                        $('#saved-name').val($('#name').val());
                        $('#saved-uid').val($('#uid').val());
                        $('#saved-start').val($('#startDate').val());
                    }
                    else if (resp.code !== 0) $dataStat.text(resp.status);
                    else {
                        const user = new UserFull(resp.data, startDate, endDate);
                        const username = getPlaterName(userId);
                        const drawInfo = new DrawInfo(userId, user, $("#mode option[value=" + mode + "]").text() + ": " + getDateString(startDate) + "~" + getDateString(endDate), username);
                        mothershipData.push(drawInfo);
                        updateTable();
                        $('#getDataConsole').text("è·å–æ•°æ®æˆåŠŸï¼Œæ‚¨ä¹Ÿå¯ä»¥ç»§ç»­æ·»åŠ ");
                    }
                },
                error: function (xhr) {
                    $('#getDataConsole').text("ä»å¦ˆèˆ¹è·å–æ•°æ®å¤±è´¥ï¼ˆå¦ˆèˆ¹apiç»å¸¸çˆ†ç‚¸ï¼Œè¿‡æ®µæ—¶é—´å†è¯•è¯•å§ï¼‰ " + xhr.status + " " + xhr.statusText);
                }
            });
        }

        function addDataLine(nick = "", uid = "", mode = 0, startDate = "") {
            const table = $("#dataListTable");
            dataIndex += 1;
            const ltr = $("<tr>", { style: "line-height:30px;" });
            // é€‰æ‹©
            let td = $("<td>").appendTo(ltr);
            let $choose = $("<input>", { id: "choose-" + dataIndex, type: "checkbox", style: "width: 20px; height:20px" }).appendTo(td);
            $choose.hide();
            // æ˜µç§°
            td = $("<td>").appendTo(ltr);
            $("<input>", { id: "nick-" + dataIndex, type: "text", val: nick }).appendTo(td);
            // uid
            td = $("<td>").appendTo(ltr);
            $("<input>", { id: "uid-" + dataIndex, type: "text", val: uid }).appendTo(td);
            // æ¨¡å¼
            td = $("<td>").appendTo(ltr);
            $("<select id='mode-" + dataIndex + "'><option value='0'>Standard</option><option value='1'>Taiko</option><option value='2'>Catch The Beat</option><option value='3'>Mania</option></select>").appendTo(td);
            // èµ·å§‹æ—¥æœŸ
            td = $("<td>").appendTo(ltr);
            $("<input>", { id: "startDate-" + dataIndex, type: "text", val: startDate }).appendTo(td);
            // æˆªæ­¢æ—¥æœŸ
            td = $("<td>").appendTo(ltr);
            $("<input>", { id: "endDate-" + dataIndex, type: "text", val: getDateString(new Date()) }).appendTo(td);
            // æ•°æ®æç¤º
            td = $("<td>").appendTo(ltr);
            $("<span>", { id: "dataStat-" + dataIndex, val: "è¯·ç‚¹å‡»â€œè·å–æ•°æ®â€æŒ‰é’®" }).appendTo(td);
            // æ“ä½œ
            td = $("<td>").appendTo(ltr);
            let $getDataBtn = $("<input>", { id: "getDataBtn-" + dataIndex, type: "button", val: "è·å–æ•°æ®" }).appendTo(td);
            $getDataBtn.click(() => {
                const $this = $(this);
                $this.attr("disabled", true);
                const index = $this.attr("id").split("-")[1];
                const $dataStat = $("dataStat-" + index);
                $dataStat.text("æ­£åœ¨è·å–æ•°æ®ï¼Œè¯·ç¨ç­‰...");
                const userId = $("uid-" + index).val();
                const mode = parseInt($("mode-" + index).val());
                const startDate = new Date($("startDate-" + index).val());
                const endDate = new Date($("endDate-" + index).val());
                getMothershipData($dataStat, userId, startDate, endDate, mode);
                setTimeout(() => {
                    $(this).removeAttr('disabled');
                }, 5000);
            });

            let $saveSettingBtn = $("<input>", { id: "saveSetting-" + dataIndex, type: "button", val: "åŠ å…¥é¢„ç½®" }).appendTo(td);


            ltr.appendTo(table);
        }

    </script>

    <script type="text/javascript">
        let dragresize = new DragResize('dragresize',
            { minWidth: 50, minHeight: 50, minLeft: 20, minTop: 20, maxLeft: 10000, maxTop: 10000 });
        dragresize.isElement = function (elm) {
            if (elm.className && elm.className.indexOf('drsElement') > -1) return true;
        };
        dragresize.isHandle = function (elm) {
            if (elm.className && elm.className.indexOf('drsMoveHandle') > -1) return true;
        };
        dragresize.apply(document);
    </script>

    <script type="text/javascript">
        function downloadJSAtOnload() {
            $("#drawBtn").text("åŠ è½½ä¸­ï¼Œè¯·ç¨ç­‰...");
            let element = document.createElement("script");
            element.src = "https://cdn.plot.ly/plotly-latest.min.js";
            element.onload = function () {
                $('#drawBtn').attr("disabled", false);
                $("#drawBtn").text("ç»˜åˆ¶æŠ˜çº¿å›¾");
                $("#drawBtn").click(function () {
                    if (mothershipData.length <= 0) $("#graph").append($('<div class="draw-warning"><span>è¯·å…ˆè·å–æ•°æ®</span></div>'));
                    else {
                        $(".draw-warning").remove();
                        const xName = $("#xcor").val();
                        const xTitle = $("#xcor option[value=" + xName + "]").text()
                        const yName = $("#ycor").val();
                        const yTitle = $("#ycor option[value=" + yName + "]").text()
                        let datas = [];
                        $("#playerlist tr:gt(0)").each(function (index, tr) {
                            let checkbox = $("input:checkbox", tr);
                            if (checkbox.is(':checked')) {
                                let index = parseInt(checkbox.attr("id").split("-")[1]);
                                datas.push(mothershipData[index].getTrace(xName, yName));
                            }
                        });
                        const layout = {
                            title: {
                                text: xTitle + "-" + yTitle
                            },
                            xaxis: {
                                title: {
                                    text: xTitle
                                }
                            },
                            yaxis: {
                                title: {
                                    text: yTitle
                                }
                            }
                        };
                        Plotly.newPlot('graph', datas, layout, { scrollZoom: true });
                    }
                });
            }

            document.body.appendChild(element);
        }
        if (window.addEventListener)
            window.addEventListener("load", downloadJSAtOnload, false);
        else if (window.attachEvent)
            window.attachEvent("onload", downloadJSAtOnload);
        else window.onload = downloadJSAtOnload;

    </script>



</body>

</html>